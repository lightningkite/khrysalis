// Generated by Khrysalis TypeScript converter
// File: views/CustomView.actual.kt
// Package: com.lightningkite.khrysalis.views

import {CustomViewDelegate} from "./CustomViewDelegate.shared";
import {DisplayMetrics} from "./DisplayMetrics.actual";
import {DisposableLambda, getAndroidViewViewRemoved} from "../rx/DisposeCondition.actual";

const customViewDelegateSymbol = Symbol("customViewDelegateSymbol");
const customViewConfiguredSymbol = Symbol("customViewConfiguredSymbol");

declare global {
    interface HTMLCanvasElement {
        [customViewDelegateSymbol]: CustomViewDelegate | undefined
        [customViewConfiguredSymbol]: boolean | undefined
    }
}

export function customViewSetDelegate(view: HTMLCanvasElement, delegate: CustomViewDelegate) {
    view[customViewDelegateSymbol]?.dispose();
    delegate.customView = view;

    if(!view[customViewConfiguredSymbol]){
        view[customViewConfiguredSymbol] = true;
        getAndroidViewViewRemoved(view).call(new DisposableLambda(()=>{
            view[customViewDelegateSymbol]?.dispose();
            view[customViewDelegateSymbol] = null;
        }))
    }

    view.onpointerdown = (e) => {
        const b = view.getBoundingClientRect();
        delegate.onTouchDown(e.pointerId, e.pageX - b.x, e.pageY - b.y, view.width, view.height)
    }
    view.onpointermove = (e) => {
        const b = view.getBoundingClientRect();
        delegate.onTouchMove(e.pointerId, e.pageX - b.x, e.pageY - b.y, view.width, view.height)
    }
    view.onpointercancel = (e) => {
        const b = view.getBoundingClientRect();
        delegate.onTouchCancelled(e.pointerId, e.pageX - b.x, e.pageY - b.y, view.width, view.height)
    }
    view.onpointerup = (e) => {
        const b = view.getBoundingClientRect();
        delegate.onTouchUp(e.pointerId, e.pageX - b.x, e.pageY - b.y, view.width, view.height)
    }

    const p = view.parentElement;
    if(p){
        const obs = new ResizeObserver(function callback(){
            if(!view.style.width.endsWith("%") && !(p.style.flexDirection == "column" && view.style.alignSelf == "stretch")){
                view.style.width = delegate.sizeThatFitsWidth(p.scrollWidth, p.scrollHeight).toString() + "px";
            }
            if(!view.style.height.endsWith("%") && !(p.style.flexDirection == "row" && view.style.alignSelf == "stretch")) {
                view.style.height = delegate.sizeThatFitsHeight(p.scrollWidth, p.scrollHeight).toString() + "px";
            }
            if(!document.contains(view)) {
                obs.disconnect();
            }
        });
        obs.observe(p);
    }

    if(view.getContext){
        const ctx = view.getContext("2d");
        view.width = view.offsetWidth;
        view.height = view.offsetHeight;
        delegate.draw(ctx, view.width, view.height, DisplayMetrics.INSTANCE);
    } else {
        p?.appendChild(delegate.generateAccessibilityView());
    }
    view[customViewDelegateSymbol] = delegate;
}

export function customViewInvalidate(view: HTMLCanvasElement) {
    const delegate = view[customViewDelegateSymbol];
    if(!delegate) return;
    if(view.getContext){
        const ctx = view.getContext("2d");
        view.width = view.offsetWidth;
        view.height = view.offsetHeight;
        ctx.clearRect(0, 0, view.width, view.height);
        delegate.draw(ctx, view.width, view.height, DisplayMetrics.INSTANCE);
    }
}